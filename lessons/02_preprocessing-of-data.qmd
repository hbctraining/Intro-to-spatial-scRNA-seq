---
title: "Pre-processing of Spatial Data"
authors: "Will Gammerdinger, Noor Sohail, Zhu Zhuo, James Billingsley, Shannan Ho Sui"
date: "Tuesday, July 22, 2025"
editor_options: 
  markdown: 
    wrap: 72
---

Approximate time: XY minutes

# Learning Objectives

-   Describe the data set that we will be using for this analysis
-   Read in the data to a Seurat object
-   Discuss the slots in the Seurat object that have been filled after reading in the data

# The Dataset

TODO

## Metadata

::: {.panel-tabset}

### Human CRC

Matched control and cancerous colon sample from 58 year old female in stage IV-A.

-   [Natural (control)](https://www.10xgenomics.com/platforms/visium/product-family/dataset-human-crc)
-   [Colorectal Cancer](https://www.10xgenomics.com/platforms/visium/product-family/dataset-human-crc)


### Mouse Brain

A mouse brain (fresh frozen) was obtained from Charles River Laboratories.

Strain: C57BL/6 Sex: Male Age: 8 weeks Sample preparation

A 10 µm section was taken with a cryostat (Epredia CryoStar NX70). Tissue block preparation, sectioning, H&E staining, and imaging followed the Visium HD Fresh Frozen Tissue Preparation Handbook (CG000763).

The data was subset to a smaller cross-section of the brain in order to make it more manageable on local laptops. The instructions for how to subset a 10X Visium HD slides can be found [here](Aside_subsetting_slide.qmd).

:::

## Downloading the R Project and Data

We have assembled an R Project for you to download that includes the data along with a basic file structure for maintain good data management. It can be quite easy when starting a new analysis to want to dive right in and start analyzing your data. However, good data management practices occur at each step of data's lifecycle. It is a good habit to begin by creating a basic directory structure to hold your data. Let's start by download this R Project and data from [here](). Left-click on the link and select `Save Link As..` or `Download Linked File As..`, then select a place on your computer where you would like to place this R Project.

We can open the R Project up and see that the provided file structure should look like:

```{r}
#| label: file_structure
#| echo: false
library(fs)

# Print the first level in the downloaded directory
# dir_tree("data", recurse = 1)
```

If your R Project looks like below, then you are ready to start!

TODO: **Insert picture of what the R Project will look when it is ready to start**

::: callout-tip
# [**Exercise 1**](02_preprocessing-of-data_Answer-key.qmd#exercise-1)

Given the information that we know from the metadata, what might be some questions that we are interested in interrogating using our data?
:::


```{r}
#| label: header_libraries
# Loading spatial files
# Dec 2025

library(tidyverse)
library(Seurat)
```

# Loading Data into Seurat

There are two main tools used for analyzing single-cell RNA-seq data, Python's [scanpy](https://scanpy.readthedocs.io/en/stable/) and R's [Seurat](https://satijalab.org/seurat/). While both tools have nuances that the other doesn't have, they have many functionalities in common. As this in an R-based workshop, we will be using Seurat. 

## Data Files

To read our data, we are going to make use of the function `Load10X_Spatial()`. The input needed for this function comes from the output generated by SpaceRanger, including both the feature matrix and low-resolution tissue image. Once supplied, a Seurat object with both gene-level counts and spatial information is created. There are 3 main arguments that we will be utilizing for this step:

| Argument | Description |
|---------|-------------|
| data.dir | Directory containing the H5 file specified by filename and the image data in a subdirectory called spatial |
| bin.size | Specifies the bin sizes to read in (defaults to c(16, 8)) |
| slice    | Name for the stored image of the tissue slice |

::: {.callout-note collapse=true}
# Using `?` to look up function arguments 
If you are ever unsure what parameters you can supply to a function, you make use of the `?` call in R. This will bring up the manual page for the function while will provide more details on what each variable is used for.

```{r}
#| label: function_man_page
#| eval: false
?Load10X_Spatial
```
:::

Before loading in the data, let us take a look at the files that are generated by SpaceRanger. In particular, let us take a look at sample `data/P5CRC` which is the path would supply as `data.dir` in the `Load10X_Spatial()` function.
 
```{r}
#| label: spaceranger_outs
#| echo: false
dir_tree("data/P5CRC/", recurse = 1)
```

In the Visium HD assay, in addition to providing data at the level of the 2µm x 2µm squares, SpaceRanger also bins the 2µm x 2µm squares into 8µm x 8µm and 16µm x 16µm bins. We can see each of these different resolution inside the `binned_outputs` folder. While the single-digit micron resolution is a big technological improvement over original Visium’s original ∼55μm spots, the higher resolution also presents challenges. 

| Pro                                                         | Con                                                           |
|-------------------------------------------------------------|---------------------------------------------------------------|
| Reconstructing single cells from the data, so each spot is one cell | Very small 2µm × 2µm (and 8µm × 8µm) bins may capture very little biological signal |
| Continuous expression values across the entire tissue        | Large numbers of bins increase computational time and resource requirements |

::: callout-important
# Choosing your bin size
TODO
- Depends on the size of cells in your dataset
- Mention that we will discuss segmentation more in future lessons
:::

## Creating Seurat Object

Now that we understand the input needed for the `Load10X_Spatial()` function, let's use it to create a Seurat object called `crc`. We will specify that we want to load in the `8um` and `16um` bin sizes at the same time. **Typically you would only load in one bin size, but for the purposes of better understanding bins and our Seurat object we will load both here.**

```{r}
crc <- Load10X_Spatial(
  data.dir = "data/P5CRC/",
  bin.size = c(8, 16),
  slice = "P5CRC")
```

Now we can examine its major features, which we will add to and alter throughout the lesson:

```{r}
crc
```

## Anatomy of a Seurat Object

As we can see from our Seurat callout, there are a lot of different parts inside our object. Here, we will go through each of the major components of a Seurat object and how you would access important pieces of information.

::: {.panel-tabset}

### Assays

`Assays` are where we can store different counts matrices - we are not forced to keep the same features and variable genes across assays. Each assay will contain it's own `Layers` that can be distinct from other assays in the object. This is useful in several different instances:

- Multi-modal assays, where you can keep the expression matrices for RNA, ATAC, or protein in a single Seurat object
- Storing counts matrices from a variety of different normalization techniques
- Batch integration methods will sometimes generate a transformed counts matrix

Here we can print the different assays that exist within our `crc` object:

```{r}
Assays(crc)
```

We have to separate assays for the different bin sizes, which makes sense because we have different count matrices for our cells based upon the bin size that was selected.

The `DefaultAssay()` function shows us which assay information will be used in other Seurat function calls, unless explicitly stated specific otherwise.

```{r}
DefaultAssay(crc)
```

We can also change what our default assay is. Let's set it to the `016um` bins:

```{r}
DefaultAssay(crc) <- "Spatial.016um"
crc
```
Now we see that the callout says: `Active assay: Spatial.016um `

### Layers

Layers are our count matrices. 

```{r}
Layers(crc)
```

By default, Seurat uses the following naming convention for the counts matrices within an `Assay`: 

| Layer       | Description                     |
|-------------|---------------------------------|
| counts      | Raw counts                      |
| data        | Normalized counts               |
| scale.data  | Scaled‑normalized counts        |

You may notice that our Seurat object only contains `counts` right now. This is because we have not run any normalization steps yet (we will discuss how to do so in future lessons).

Using the `LayerData()` function we can access the entire counts matrix. Furthermore, we can specify the `assay` if we would prefer to not use the `DefaultAssay`.

```{r}
LayerData(crc, 
          assay = "Spatial.016um", 
          layer = "count")[1:5, 1:5]
```
By printing the first 5 features and cells in our object (for easier visualization). We can see that we are working with **whole numbers** which reinforces the idea that this is the **raw data**, with no tranformations having been applied.


### Features and Cells

Our count matrices function as any other matrix does, with rows and columns. 

In Seurat, the rows correspond to `Features`. In the case of spatial transcriptomics, our features are genes. In other experiments, features could refer to chromatin peaks or protein. Since our features are not always genes, we will see the term `Feature` appear in Seurat function later. The important thing to recall is that in this Visium HD dataset, we are quantifying RNA expression (genes).

We can see what the first few genes in our count matrix are:

```{r}
Features(crc) %>% head()
```

As well as see the number of genes that are found in each of our assays:

```{r}
nrow(crc[["Spatial.008um"]])
nrow(crc[["Spatial.016um"]])
```


In Seurat, the rows correspond to `Cells` (or samples as it appears in the callout). 

We can see what the first few cells in our count matrix are:

```{r}
Cells(crc) %>% head()
```

As well as see the number of cells that are found in each of our assays:

```{r}
ncol(crc[["Spatial.008um"]])
ncol(crc[["Spatial.016um"]])
```

::: callout-important
# Bin size
Did you notice that the number of cells is different between our `8um` and `16um` bins?

This is why the bin value matters, it determines how many "cells" are ultimately generated. Where a smaller bin size results in more spots.
:::

### Spatial field

We do not just have expression data associated with our sample, we also have the spatial slide that comes with its own set of values and information.

For example we can grab the x,y coordinates of each spot using the `GetTissueCoordinates()` function.

```{r}
GetTissueCoordinates(crc) %>% head()
```

Or visualize what our slide looks like:

```{r}
SpatialDimPlot(crc)
```

### Metadata

**Seurat automatically creates some metadata** for each of the cells when the object is created. This information is stored in the `@meta.data` slot within the Seurat object. 

```{r}
crc@meta.data %>% head()
```

What does each column represent?

| Column        | Description                                   |
|---------------|-----------------------------------------------|
| orig.ident    | Sample identity if known; defaults to “s”     |
| nCount_RNA    | Number of UMIs per cell                       |
| nFeature_RNA  | Number of genes detected per cell             |

While it may seem intimidating at first, the important thing to remember is that this is a dataframe. Therefore can modify and work with this dataframe just like we would any other in R! For example, we can set our `orig.ident` column to be our sample name rather than "s".

```{r}
crc@meta.data$orig.ident <- "P5CRC"
crc@meta.data %>% head()
```

Additionally, we do not have use the `@meta.data` each time we want to access a column. We can use the `$` to get information from a column.

```{r}
crc$nCount_Spatial.008um %>% head()
```
:::

::: callout-tip
# [**Exercise 2**](02_preprocessing-of-data_Answer-key.qmd#exercise-2)

Exercise 1
:::

# Loading Multiple Samples into Seurat

## Sub-topic 1

## Sub-topic 2

## Sub-topic 3

::: callout-tip
# [**Exercise 3**](02_preprocessing-of-data_Answer-key.qmd#exercise-3)

Exercise 3
:::